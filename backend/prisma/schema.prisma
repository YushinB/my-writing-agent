// Prisma Schema for ProsePolish Backend
// Database: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  ADMIN
}

// User Model
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(USER)
  suspended Boolean  @default(false)
  suspendedAt DateTime?
  suspendedBy String?

  // Profile fields
  displayName String?
  avatar      String?  // URL or path to avatar image
  hobbies     String?  // Stored as comma-separated or JSON string

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  savedWords SavedWord[]
  settings   UserSettings?
  aiUsageLogs AIUsageLog[]
  auditLogsAsTarget AuditLog[] @relation("AuditLogUser")
  auditLogsAsActor  AuditLog[] @relation("AuditLogActor")

  // AI Gateway Relations
  aiGatewayUsage AIUsage[]
  aiQuota        AIQuota?
  modelPreferences UserModelPreference[]

  @@index([email])
  @@index([suspended])
  @@map("users")
}

// Saved Words Model (User's Personal Dictionary)
model SavedWord {
  id        String   @id @default(uuid())
  userId    String
  word      String
  notes     String?
  tags      String[] @default([])  // Array of tags for categorization
  favorite  Boolean  @default(false) // Mark as favorite
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, word])
  @@index([userId])
  @@index([word])
  @@index([userId, favorite])
  @@index([userId, tags])
  @@map("saved_words")
}

// Dictionary Entry Model (Cached Dictionary Data)
model DictionaryEntry {
  id          String   @id @default(uuid())
  word        String   @unique
  phonetic    String?
  meanings    Json     // Array of meanings with definitions, examples, synonyms
  origin      String?
  source      String   // "free_dictionary_api" or "gemini_ai"
  cachedAt    DateTime @default(now())
  lastAccessed DateTime @default(now())
  accessCount Int      @default(0)
  expiresAt   DateTime?

  @@index([word])
  @@index([lastAccessed])
  @@index([expiresAt])
  @@map("dictionary_entries")
}

// User Settings Model
model UserSettings {
  id        String   @id @default(uuid())
  userId    String   @unique

  // LLM Preferences
  llmModel  String   @default("gemini-2.0-flash")

  // Dictionary Preferences
  preferredLanguage String @default("en")

  // UI Preferences
  theme     String   @default("light")

  // Notification Preferences
  emailNotifications Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_settings")
}

// AI Usage Log Model (Track API calls for billing/monitoring)
model AIUsageLog {
  id            String   @id @default(uuid())
  userId        String
  operation     String   // "correct_text", "define_word", "generate_suggestions", "analyze_style"
  inputTokens   Int      @default(0)
  outputTokens  Int      @default(0)
  totalTokens   Int      @default(0)
  model         String
  cached        Boolean  @default(false)
  costEstimate  Float?
  createdAt     DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([operation])
  @@map("ai_usage_logs")
}

// Audit Log Model (Track admin actions)
model AuditLog {
  id          String   @id @default(uuid())
  actorId     String   // Admin who performed the action
  targetId    String?  // User affected by the action (nullable for system-wide actions)
  action      String   // "suspend_user", "enable_user", "change_role", "reset_password", "update_settings"
  details     Json?    // Additional context about the action
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  actor  User  @relation("AuditLogActor", fields: [actorId], references: [id], onDelete: Cascade)
  target User? @relation("AuditLogUser", fields: [targetId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([targetId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ========================================
// AI Gateway Models
// ========================================

// AI Provider Model (Registry of available AI providers)
model AIProvider {
  id          String   @id @default(uuid())
  name        String   @unique // "openai", "deepseek", "huggingface", etc.
  displayName String   // "OpenAI", "DeepSeek", "Hugging Face"
  description String?

  // Configuration
  enabled     Boolean  @default(true)
  priority    Int      @default(0) // Higher priority = preferred in routing

  // API Configuration (stored as JSON for flexibility)
  config      Json?    // API endpoints, default settings, etc.

  // Pricing (USD per 1K tokens)
  promptCostPer1k     Float   @default(0)
  completionCostPer1k Float   @default(0)

  // Rate Limits
  requestsPerMinute Int     @default(60)
  requestsPerDay    Int     @default(10000)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usage         AIUsage[]
  healthRecords ProviderHealth[]

  @@index([enabled])
  @@index([priority])
  @@map("ai_providers")
}

// AI Usage Model (Track Gateway usage per request)
model AIUsage {
  id         String   @id @default(uuid())
  userId     String
  providerId String

  // Request Details
  model      String   // Specific model used (e.g., "gpt-4", "deepseek-chat")
  operation  String   // "generate", "chat", "complete"
  prompt     String?  // Optional: store prompt for debugging (be mindful of PII)

  // Token Usage
  promptTokens     Int @default(0)
  completionTokens Int @default(0)
  totalTokens      Int @default(0)

  // Performance Metrics
  latency    Int      // Response time in milliseconds
  cached     Boolean  @default(false)
  successful Boolean  @default(true)

  // Cost
  estimatedCost Float  @default(0) // USD

  // Error Info (if failed)
  errorCode    String?
  errorMessage String?

  // Metadata
  requestId String?  @unique // For request tracing
  metadata  Json?    // Additional context
  createdAt DateTime @default(now())

  // Relations
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId])
  @@index([createdAt])
  @@index([successful])
  @@index([userId, createdAt])
  @@index([providerId, createdAt])
  @@map("ai_usage")
}

// AI Quota Model (User quotas and limits)
model AIQuota {
  id     String @id @default(uuid())
  userId String @unique

  // Daily Limits
  dailyRequestLimit   Int @default(1000)
  dailyRequestCount   Int @default(0)
  dailyResetAt        DateTime

  // Monthly Limits
  monthlyRequestLimit Int   @default(10000)
  monthlyRequestCount Int   @default(0)
  monthlySpendLimit   Float @default(10.00) // USD
  monthlySpendAmount  Float @default(0.00)  // USD
  monthlyResetAt      DateTime

  // Tier/Plan (for future use)
  tier String @default("free") // "free", "pro", "enterprise"

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dailyResetAt])
  @@index([monthlyResetAt])
  @@map("ai_quotas")
}

// Provider Health Model (Track provider availability and performance)
model ProviderHealth {
  id         String   @id @default(uuid())
  providerId String

  // Health Status
  healthy      Boolean @default(true)
  statusCode   Int?    // HTTP status code or custom code
  errorMessage String?

  // Performance Metrics
  averageLatency Float? // Average response time in ms
  errorRate      Float? // Error rate (0.0 - 1.0)

  // Circuit Breaker Info
  consecutiveFailures Int     @default(0)
  lastFailureAt       DateTime?

  // Metadata
  checkedAt DateTime @default(now())
  metadata  Json?    // Additional health check data

  // Relations
  provider AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([checkedAt])
  @@index([healthy])
  @@map("provider_health")
}

// User Model Preference (User's preferred AI models)
model UserModelPreference {
  id       String @id @default(uuid())
  userId   String

  // Preference Details
  provider String   // Provider name (e.g., "openai", "deepseek")
  model    String   // Model ID (e.g., "gpt-4", "deepseek-chat")

  // Context/Use Case (optional)
  context  String?  // "general", "coding", "writing", etc.

  // Priority
  isDefault Boolean @default(false) // Default model for all operations
  priority  Int     @default(0)     // Higher = more preferred

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, model, context])
  @@index([userId])
  @@index([userId, isDefault])
  @@map("user_model_preferences")
}
